- name: Add fish apt repo
  become: yes
  apt_repository:
    repo: "ppa:fish-shell/release-3"
  register: apt_repo

- name: Install fish
  apt: name=fish state=present
  become_method: sudo

- name: Get shell executable location
  command: which fish
  register: fish
  changed_when: fish.rc != 0

- name: Set fish as default shell
  user: name="{{ user }}" shell="{{ fish.stdout }}"
  become: yes

- name: Ensure config directory exists
  file: "path={{ fish_dir }} state=directory"

- name: Link config files
  loop:
    - functions
    - completions
    - conf.d
    - config.fish
  file:
    src: "{{ dotfiles_home }}/roles/fish/files/{{item}}"
    dest: "{{ fish_dir }}/{{item}}"
    state: link
    force: yes

- name: Add fish paths
  loop:
    - "~/bin"
    - "~/dotfiles/bin"
    - "node_modules/bin"
  shell: "echo fish_add_path {{item}} | fish"
  register: fish_path
  failed_when: fish_path.rc > 1
  changed_when: fish_path.rc == 0

- name: Add fish abbreviations
  loop:
    - word: dc
      expansion: docker-compose
    - word: g
      expansion: git
    - word: gc
      expansion: git commit
    - word: p
      expansion: gopass
    - word: tf
      expansion: terraform
  shell: "echo abbr --add {{ item.word}} '{{ item.expansion }}' | fish"
  register: fish_abbr
  failed_when: fish_abbr.rc > 1
  changed_when: fish_abbr.rc == 1

- name: Set fish variables
  loop:
    - name: fish_greeting
      value: ""
    - name: EDITOR
      value: vim
    - name: fish_color_normal
      value: normal
    - name: fish_color_command
      value: ffd75f
    - name: fish_color_quote
      value: cccc0c
    - name: fish_color_redirection
      value: 00afff
    - name: fish_color_end
      value: 00ff00
    - name: fish_color_error
      value: ff0000
    - name: fish_color_param
      value: 00ffc8
    - name: fish_color_comment
      value: a8a8a8
    - name: fish_color_match
      value: normal
    - name: fish_color_selection
      value: c0c0c0
    - name: fish_pager_color_progress
      value: brwhite --background=cyan
    - name: fish_pager_color_prefix
      value: normal --bold --underline
    - name: fish_pager_color_description
      value: B3A06D yellow
    - name: fish_pager_color_completion
      value: normal
    - name: fish_color_cancel
      value: normal
    - name: fish_color_host
      value: normal
    - name: fish_color_user
      value: 00ff00
    - name: fish_color_autosuggestion
      value: 555
    - name: fish_color_valid_path
      value: normal
    - name: fish_color_cwd_root
      value: 800000
    - name: fish_color_cwd
      value: ad73d9
    - name: fish_color_escape
      value: 00a6b2
    - name: fish_color_operator
      value: 00a6b2
    - name: fish_color_history_current
      value: normal
    - name: fish_color_search_match
      value: --background=b89442
  shell: "echo set -U {{ item.name }} '{{ item.value }}' | fish"
  register: fish_set
  failed_when: fish_set.rc > 1
  changed_when: fish_set.rc == 1

- name: Check if omf is installed
  stat:
    path: "{{ omf_dir }}"
  register: omf

- name: Clone oh-my-fish repo
  when: not omf.stat.exists
  git:
    repo: "https://github.com/oh-my-fish/oh-my-fish"
    version: v7
    dest: "/tmp/omf"
    clone: yes

- name: Install oh-my-fish
  when: not omf.stat.exists
  command: /tmp/omf/bin/install -y --offline --noninteractive
